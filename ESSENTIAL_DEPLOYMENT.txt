# Essential AWS EC2 Deployment Guide - Turbo-Doc Backend

## Quick Start Checklist
- [ ] Launch EC2 t3.micro instance (Ubuntu 22.04)
- [ ] Install required software (Node.js, pnpm, LibreOffice)
- [ ] Clone repository and configure environment
- [ ] Build and start application with PM2
- [ ] Configure Nginx reverse proxy
- [ ] Setup SSL certificate

---

## 1. Launch EC2 Instance

**Instance Configuration:**
- AMI: Ubuntu Server 22.04 LTS
- Type: t3.micro (1GB RAM, 1 vCPU)
- Storage: 15-20GB gp3 (needs space for LibreOffice)
- Create/use SSH key pair

**Security Group:**
```
SSH (22)        - Your IP only
HTTP (80)       - 0.0.0.0/0
HTTPS (443)     - 0.0.0.0/0
```

**Connect:**
```bash
chmod 400 your-key.pem
ssh -i your-key.pem ubuntu@YOUR_EC2_IP
```

---

## 2. Install Required Software

### System Update
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl git build-essential
```

### Node.js 20 LTS
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
```

### pnpm
```bash
curl -fsSL https://get.pnpm.io/install.sh | sh -
export PNPM_HOME="/home/ubuntu/.local/share/pnpm"
export PATH="$PNPM_HOME:$PATH"
echo 'export PNPM_HOME="/home/ubuntu/.local/share/pnpm"' >> ~/.bashrc
echo 'export PATH="$PNPM_HOME:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

### Critical System Libraries
```bash
# Image processing library (for Sharp)
sudo apt install -y libvips-dev libvips42

# PostgreSQL client library (for Prisma/node-postgres)
sudo apt install -y libpq-dev
```

### LibreOffice (CRITICAL for Document Conversion)
```bash
# Install LibreOffice headless (no GUI) for DOC/DOCX to PDF conversion
sudo apt install -y libreoffice-writer libreoffice-calc libreoffice-impress

# Install additional dependencies for headless mode
sudo apt install -y libreoffice-java-common default-jdk

# Verify installation
libreoffice --version

# Test headless conversion (optional)
# libreoffice --headless --convert-to pdf --outdir /tmp/ test.docx
```

### PM2 (Process Manager)
```bash
sudo npm install -g pm2
```

### Nginx (Reverse Proxy)
```bash
sudo apt install -y nginx
sudo systemctl enable nginx
```

### Firewall Setup (Security)
```bash
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw --force enable
```

---

## 3. Deploy Application

### Clone Repository
```bash
cd ~
git clone https://github.com/YOUR_USERNAME/Turbo-Doc.git
cd Turbo-Doc
```

### Install Dependencies
```bash
pnpm install
cd packages/database && pnpm db:generate && cd ../..
```

### Configure Environment
```bash
nano .env
```

**Essential Environment Variables:**
```env
# Server
API_PORT=4000
NODE_ENV=production

# Database (Neon)
DATABASE_URL="postgresql://user:password@host:5432/database"

# Auth
BETTER_AUTH_SECRET="your-secret"
BETTER_AUTH_URL="https://turbodoc.sharad.fun"

# App URLs
NEXT_PUBLIC_APP_URL="https://turbodoc.sharad.fun"
API_URL="https://api.your-domain.com"

# AWS S3 (REQUIRED - no fallbacks)
AWS_ACCESS_KEY_ID="your-key"
AWS_SECRET_ACCESS_KEY="your-secret"
AWS_REGION="ap-southeast-2"
AWS_BUCKET_NAME="turbo-doc"
AWS_CLOUDFRONT_URL="https://your-cloudfront-url"

# Razorpay
TEST_API_KEY="rzp_test_..."
TEST_API_SECRET="your-secret"
TEST_API_WEBHOOK_SECRET="your-webhook-secret"

# OAuth
GOOGLE_CLIENT_ID="your-id"
GOOGLE_CLIENT_SECRET="your-secret"
GITHUB_CLIENT_ID="your-id"
GITHUB_CLIENT_SECRET="your-secret"
```

### Build Backend
```bash
cd apps/api
pnpm build
```

### Run Database Setup
```bash
cd packages/database
pnpm exec prisma migrate deploy
pnpm db:seed
cd ../..
```

### Secure Environment File
```bash
chmod 600 .env
```

---

## 4. Configure PM2 (Keep Backend Running)

### Create PM2 Config
```bash
nano ecosystem.config.cjs
```

**Copy this configuration:**
```javascript
module.exports = {
  apps: [
    {
      name: 'turbo-doc-api',
      cwd: '/home/ubuntu/Turbo-Doc/apps/api',
      script: 'dist/index.js',
      instances: 1,
      exec_mode: 'fork',  // Use fork for single instance on t3.micro
      env: {
        NODE_ENV: 'production',
        API_PORT: 4000,
      },
      error_file: '/home/ubuntu/logs/api-error.log',
      out_file: '/home/ubuntu/logs/api-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      autorestart: true,
      max_memory_restart: '800M',  // Restart if memory exceeds 800MB
      max_restarts: 10,
      min_uptime: '10s',
      kill_timeout: 5000,  // Graceful shutdown timeout
      watch: false,
    },
  ],
};
```

### Start Application
```bash
mkdir -p ~/logs
pm2 start ecosystem.config.cjs
pm2 status
```

### Configure Auto-Start on Reboot
```bash
# Generate startup script
pm2 startup

# Run the command PM2 shows (copy and paste it)
# Then save the process list
pm2 save
```

**PM2 will now:**
- Automatically restart your app if it crashes
- Start your app when the server reboots
- Keep logs in `~/logs/` directory

---

## 5. Configure Nginx

### Create Nginx Config
```bash
sudo nano /etc/nginx/sites-available/turbo-doc-api
```

**Paste this:**
```nginx
server {
    listen 80;
    server_name api.your-domain.com;

    # Large uploads for documents
    client_max_body_size 100M;

    # Special handling for Razorpay webhooks (raw body required)
    location /api/v1/payments/webhook {
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Critical: don't buffer for signature verification
        proxy_request_buffering off;
        client_body_buffer_size 1M;
    }

    location / {
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeouts for document conversion
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        proxy_cache_bypass $http_upgrade;
    }
}
```

### Enable Site
```bash
sudo ln -s /etc/nginx/sites-available/turbo-doc-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 6. Setup SSL (HTTPS)

### Install Certbot
```bash
sudo apt install -y certbot python3-certbot-nginx
```

### Get SSL Certificate
```bash
# Replace with your actual domain
sudo certbot --nginx -d api.your-domain.com

# Follow prompts and choose to redirect HTTP to HTTPS
```

Certificate auto-renews automatically via cron job.

---

## 7. Add Swap Space (Prevent Memory Issues)

**IMPORTANT:** t3.micro only has 1GB RAM. Add swap to prevent crashes:

```bash
# Create 2GB swap file
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Make permanent
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# Verify
free -h
```

---

## Essential Commands

### Check Application Status
```bash
pm2 status                    # Check if running
pm2 logs turbo-doc-api       # View logs
pm2 restart turbo-doc-api    # Restart app
pm2 monit                    # Monitor resources
```

### Update Deployment
```bash
cd ~/Turbo-Doc
git pull origin main
cd apps/api && pnpm build
pm2 restart turbo-doc-api
pm2 logs --lines 20
```

### Check LibreOffice
```bash
libreoffice --version
ps aux | grep soffice  # Check if running
```

### Monitor Resources
```bash
free -h      # Memory usage
df -h        # Disk usage
pm2 monit    # App resources
```

### View Logs
```bash
# Application logs
pm2 logs turbo-doc-api --lines 50

# Nginx logs
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

---

## Troubleshooting

### App Keeps Crashing
```bash
# Check logs
pm2 logs turbo-doc-api --err

# Check memory
free -h

# Add swap if not already done (see section 7)

# Reduce PM2 instances
pm2 delete turbo-doc-api
# Edit ecosystem.config.cjs: set instances to 1
pm2 start ecosystem.config.cjs
```

### Document Conversion Fails
```bash
# Check LibreOffice is installed
libreoffice --version

# Check if LibreOffice processes are stuck
ps aux | grep soffice
# If stuck, kill them:
killall soffice.bin

# Test conversion manually
cd /tmp
libreoffice --headless --convert-to pdf test.docx
```

### Out of Memory
```bash
# Check memory
free -h

# Check swap
swapon --show

# Add more swap if needed (increase 2G to 4G)
sudo swapoff /swapfile
sudo rm /swapfile
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### SSL Certificate Issues
```bash
sudo certbot renew
sudo certbot certificates
```

### Disk Space Issues
```bash
# Check disk usage
df -h

# Find large temp files
du -sh /tmp/*

# Clean old temp files (older than 1 hour)
find /tmp -type f -name "*.pdf" -mmin +60 -delete
find /tmp -type f -name "*.jpg" -mmin +60 -delete
find /tmp -type f -name "*.png" -mmin +60 -delete

# Add to crontab for automatic cleanup (optional)
crontab -e
# Add: 0 * * * * find /tmp -type f \( -name "*.pdf" -o -name "*.jpg" -o -name "*.png" \) -mmin +60 -delete
```

---

## Summary

**Your backend is now:**
- ✅ Running with PM2 (auto-restart on crash)
- ✅ Auto-starts on server reboot
- ✅ Has LibreOffice for document conversion
- ✅ Has swap space to prevent memory issues
- ✅ Secured with SSL/HTTPS
- ✅ Accessible at `https://api.your-domain.com`

**To keep it running smoothly:**
1. Monitor logs: `pm2 logs`
2. Check resources: `pm2 monit`
3. Update regularly: `git pull && pnpm build && pm2 restart`
4. Keep system updated: `sudo apt update && sudo apt upgrade`

**Critical Files:**
- Application: `~/Turbo-Doc/apps/api/`
- Environment: `~/Turbo-Doc/.env`
- Logs: `~/logs/`
- PM2 Config: `~/Turbo-Doc/ecosystem.config.cjs`
